name: Build

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # ── 1. Build the React web UI ───────────────────────────────────────────────
  build-web:
    name: Build Web UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          # cache omitted: package-lock.json is not committed yet.
          # Commit it after first run to enable caching.

      - name: Install & build
        working-directory: web
        run: |
          npm install
          npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/
          retention-days: 1

  # ── 2. Lint ─────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      # go mod tidy generates go.sum so golangci-lint typecheck resolves imports.
      - name: Tidy modules
        run: go mod tidy

      - uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          # -tags noembed activates embed_stub.go instead of embed_prod.go.
          # embed_stub.go uses an in-memory fstest.MapFS so there is no
          # //go:embed directive that would require web/dist to exist on disk.
          args: --timeout=5m --build-tags noembed

  # ── 3. Cross-compile ────────────────────────────────────────────────────────
  build-go:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: build-web
    strategy:
      fail-fast: false
      matrix:
        include:
          - { goos: linux, goarch: amd64 }
          - { goos: linux, goarch: arm64 }

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      # Populate web/dist with the real React build before go:embed runs.
      - name: Download web dist
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: web/

      - name: Tidy & download modules
        run: go mod tidy

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          GOMIPS: ${{ matrix.gomips }}
          CGO_ENABLED: '0'
        run: |
          ARCH="${GOARCH}"
          [ -n "$GOARM"  ] && ARCH="${GOARCH}v${GOARM}"
          [ -n "$GOMIPS" ] && ARCH="${GOARCH}_${GOMIPS}"
          SUFFIX=""
          [ "$GOOS" = "windows" ] && SUFFIX=".exe"

          OUTPUT="dist/singbox-manager-${GOOS}-${ARCH}${SUFFIX}"
          mkdir -p dist

          go build \
            -ldflags="-s -w -X main.version=$(git describe --tags --always --dirty)" \
            -trimpath \
            -o "$OUTPUT" \
            ./cmd/singbox-manager

          echo "Built: $OUTPUT  ($(du -sh "$OUTPUT" | cut -f1))"

      - uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goarm && format('v{0}', matrix.goarm) || '' }}
          path: dist/

  # ── 4. GitHub Release (tag only) ─────────────────────────────────────────────
  package:
    name: Release
    runs-on: ubuntu-latest
    needs: build-go
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: release/
          merge-multiple: true

      - name: Generate SHA256 checksums
        working-directory: release
        run: sha256sum * > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
