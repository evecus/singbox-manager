name: Build

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # ── 1. 构建 React 前端 ──────────────────────────────────────────────────
  build-web:
    name: Build Web UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & build
        working-directory: web
        run: |
          npm install
          npm run build

      # 将打包后的 dist 文件夹上传，注意 path 指向 web/dist
      - uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist/
          retention-days: 1

  # ── 2. 代码静态检查 (Lint) ────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Tidy modules
        run: go mod tidy

      - uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          # 使用 noembed 标签跳过对真实 web/dist 目录的依赖检查
          args: --timeout=5m --build-tags noembed

  # ── 3. 交叉编译 Go 二进制文件 ──────────────────────────────────────────────
  build-go:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: build-web
    strategy:
      fail-fast: false
      matrix:
        include:
          - { goos: linux, goarch: amd64 }
          - { goos: linux, goarch: arm64 }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须为 0 才能让 git describe 获取到完整的 tag 信息

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      # 【核心修复】将前端产物下载到 web/dist 目录
      # 这样 Go 编译时的 //go:embed web/dist 才能找到文件
      - name: Download web dist
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: web/dist/

      # 调试步骤：如果构建依然失败，可以查看此日志确认文件路径
      - name: Verify dist contents
        run: ls -R web/dist/

      - name: Tidy & download modules
        run: go mod tidy

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          ARCH="${GOARCH}"
          [ -n "$GOARM"  ] && ARCH="${GOARCH}v${GOARM}"
          [ -n "$GOMIPS" ] && ARCH="${GOARCH}_${GOMIPS}"
          SUFFIX=""
          [ "$GOOS" = "windows" ] && SUFFIX=".exe"

          OUTPUT="dist/singbox-manager-${GOOS}-${ARCH}${SUFFIX}"
          mkdir -p dist

          # 确保在根目录执行构建，以匹配 embed 路径
          go build \
            -ldflags="-s -w -X main.version=$(git describe --tags --always --dirty)" \
            -trimpath \
            -o "$OUTPUT" \
            ./cmd/singbox-manager

          echo "Built: $OUTPUT ($(du -sh "$OUTPUT" | cut -f1))"

      - uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  # ── 4. 发布 GitHub Release (仅限 Tag 触发) ──────────────────────────────
  package:
    name: Release
    runs-on: ubuntu-latest
    needs: build-go
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: release/
          merge-multiple: true

      - name: Generate SHA256 checksums
        working-directory: release
        run: sha256sum * > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
